name: Docker Build and Test

# Trigger workflow on push to main branch or pull requests
on:
  push:
    branches: [ main ]
    paths:
      - 'week-1/hello-world-app/**'
      - '.github/workflows/docker-build.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'week-1/hello-world-app/**'
  workflow_dispatch:  # Allow manual trigger

# Environment variables
env:
  DOCKER_IMAGE_NAME: hello-devops
  DOCKER_IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-test:
    name: Build and Test Docker Image
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout code
      - name: Checkout code
        uses: actions/checkout@v4
      
      # Step 2: Set up Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      # Step 3: Build Docker image
      - name: Build Docker image
        working-directory: ./week-1/hello-world-app
        run: |
          docker build \
            -t ${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} \
            -t ${{ env.DOCKER_IMAGE_NAME }}:latest \
            .
      
      # Step 4: Test Docker image
      - name: Test Docker image
        run: |
          # Run container in background
          docker run -d \
            --name test-container \
            -p 5000:5000 \
            ${{ env.DOCKER_IMAGE_NAME }}:latest
          
          # Wait for container to be ready
          echo "Waiting for container to start..."
          sleep 10
          
          # Check if container is running
          docker ps
          
          # Test health endpoint
          echo "Testing health endpoint..."
          curl -f http://localhost:5000/health || exit 1
          
          # Test main endpoint
          echo "Testing main endpoint..."
          RESPONSE=$(curl -s http://localhost:5000/)
          echo "Response: $RESPONSE"
          
          # Verify response contains expected content
          if echo "$RESPONSE" | grep -q "ICP-9QGJ27-2026"; then
            echo "Application test passed!"
          else
            echo "Application test failed!"
            exit 1
          fi
          
          # Show container logs
          echo "Container logs:"
          docker logs test-container
          
          # Stop and remove container
          docker stop test-container
          docker rm test-container
      
      # Step 5: Scan for vulnerabilities (optional)
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.DOCKER_IMAGE_NAME }}:latest
          format: 'table'
          exit-code: '0'  # Don't fail on vulnerabilities for now
          ignore-unfixed: true
          severity: 'CRITICAL,HIGH'
      
      # Step 6: Save build artifacts
      - name: Save Docker image
        if: success()
        run: |
          docker save ${{ env.DOCKER_IMAGE_NAME }}:latest | gzip > docker-image.tar.gz
      
      - name: Upload artifact
        if: success()
        uses: actions/upload-artifact@v3
        with:
          name: docker-image
          path: docker-image.tar.gz
          retention-days: 7
      
      # Step 7: Generate build summary
      - name: Generate build summary
        if: always()
        run: |
          echo "## Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image Name:** ${{ env.DOCKER_IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "**Image Tag:** ${{ env.DOCKER_IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Docker Image Details" >> $GITHUB_STEP_SUMMARY
          docker images ${{ env.DOCKER_IMAGE_NAME }}:latest >> $GITHUB_STEP_SUMMARY || true
  
  # Optional: Push to Docker Hub (requires secrets configuration)
  push-to-registry:
    name: Push to Container Registry
    runs-on: ubuntu-latest
    needs: build-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Download artifact
        uses: actions/download-artifact@v3
        with:
          name: docker-image
      
      - name: Load Docker image
        run: |
          docker load < docker-image.tar.gz
      
      # Uncomment and configure when ready to push to ECR
      # - name: Configure AWS credentials
      #   uses: aws-actions/configure-aws-credentials@v4
      #   with:
      #     aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
      #     aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      #     aws-region: us-east-1
      
      # - name: Login to Amazon ECR
      #   id: login-ecr
      #   uses: aws-actions/amazon-ecr-login@v2
      
      # - name: Push to ECR
      #   run: |
      #     docker tag ${{ env.DOCKER_IMAGE_NAME }}:latest ${{ steps.login-ecr.outputs.registry }}/devops-internship/hello-world:latest
      #     docker push ${{ steps.login-ecr.outputs.registry }}/devops-internship/hello-world:latest
      
      - name: Build summary
        run: |
          echo "Image ready to be pushed to container registry" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To push to ECR, configure AWS credentials in GitHub Secrets" >> $GITHUB_STEP_SUMMARY